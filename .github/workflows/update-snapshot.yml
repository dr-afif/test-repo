name: Update Today Snapshot

on:
  workflow_dispatch:    # manual trigger
  schedule:
    - cron: '0 0 * * *'   # runs daily at 00:00 UTC (08:00 Malaysia time)

jobs:
  update-today-snapshot:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2️⃣ Install jq
      - name: Install jq
        run: sudo apt-get install -y jq

      # 3️⃣ Save today's roster as snapshot.json with timestamp
      - name: Save snapshot.json with timestamp
        run: |
          TODAY_DATA=$(curl -s https://sheets-proxy-backend.onrender.com/api/today || echo '{}')
          TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          echo "$TODAY_DATA" | jq --arg ts "$TIMESTAMP" '. + {last_updated: $ts}' > snapshot.json

      # 4️⃣ Commit & push if there are changes
      - name: Commit and push if changed
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add snapshot.json
          git diff --quiet && git diff --staged --quiet || git commit -m "Update today snapshot [skip ci]"

      # 4️⃣.1 Pull latest changes from remote before pushing
      - name: Pull latest changes
        run: git pull origin main --rebase --autostash origin main

      # 5️⃣ Push changes using PAT (auto-detect branch)
      - name: Push changes using PAT
        env:
          PAT_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          # Detect default branch
          DEFAULT_BRANCH=$(git remote show origin | sed -n '/HEAD branch/s/.*: //p')
          echo "Default branch is $DEFAULT_BRANCH"

          # Set remote URL with PAT
          git remote set-url origin https://x-access-token:${PAT_TOKEN}@github.com/${{ github.repository }}

          # Push to detected branch
          git push origin HEAD:$DEFAULT_BRANCH
